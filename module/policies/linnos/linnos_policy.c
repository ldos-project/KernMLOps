#include "linnos_policy.h"
#include "../../fstore/fstore.h"
#include "../../linux/drivers/md/md.h"
#include "../../linux/drivers/md/raid1.h"
#include <asm/fpu/api.h>
#include <linux/bio.h>
#include <linux/blk_types.h>
#include <linux/blkdev.h>
#include <linux/delay.h>
#include <linux/module.h>
#include <linux/module.h> /* Needed by all modules */
#include <linux/printk.h> /* Needed for pr_info() */
#include <linux/timex.h>
#define MAX_LAYER_SIZE 256
#define INPUT_SIZE     9
#define OUTPUT_SIZE    2

#define DEBUG_PRINT    0

#define PRINT_DEBUG(x) \
  if (DEBUG_PRINT)     \
    printk("%s:%d: %s\n", __FILE__, __LINE__, (x));

#define IO_BLOCKED ((struct bio*)1)
static atomic64_t duration = ATOMIC_INIT(0);
static atomic64_t times = ATOMIC_INIT(0);

static u32 select(u32 device) {
  switch (device) {
    case 271581184:
      return 0;
    case 271581186:
      return 1;
    case 271581188:
      return 2;
  }
  return 3;
}

void sort(void* base, size_t num, size_t size, cmp_func_t cmp_func, swap_func_t swap_func);

extern int (*ml_choose_best_rdev_raid1)(struct r1conf* conf, struct r1bio* r1_bio);

bool rdev_readable(struct md_rdev* rdev, struct r1bio* r1_bio);

static const float weights0[] = {
    -0.170675, -0.310538, 0.071452,  -0.208220, 0.154985,  0.007997,  -0.109730, -0.139967,
    0.049835,  -0.019587, -0.095408, 0.322943,  0.051416,  -0.138232, -0.087122, -0.312634,
    0.085944,  -0.091974, 0.241594,  0.139485,  0.248873,  -0.005619, 0.081212,  -0.173831,
    -0.319074, 0.041997,  0.019068,  -0.291366, 0.024488,  0.298530,  -0.258345, -0.265096,
    0.329241,  0.029172,  -0.118452, -0.262789, -0.227437, -0.267730, 0.147507,  -0.077608,
    -0.103543, 0.091246,  -0.187914, -0.335352, 0.185729,  0.016934,  -0.034576, -0.236914,
    0.122501,  -0.245117, -0.117475, 0.195695,  -0.304247, 0.300635,  -0.182722, -0.235783,
    -0.019404, -0.094311, 0.229431,  0.057101,  -0.009527, 0.104478,  0.024832,  -0.282639,
    -0.267013, -0.226880, -0.311521, -0.285984, 0.014922,  -0.092365, -0.230290, 0.321384,
    0.027502,  0.048040,  0.106797,  0.293313,  -0.173329, -0.079040, -0.157607, -0.232517,
    0.013843,  0.083771,  0.084590,  0.039586,  -0.029868, 0.201855,  -0.112067, 0.124092,
    -0.311389, 0.214428,  0.216397,  0.217715,  -0.065630, 0.219306,  0.049215,  -0.246675,
    0.135283,  0.122794,  -0.039823, -0.190304, 0.001957,  -0.170503, -0.135116, 0.248725,
    0.255382,  0.229485,  0.196047,  0.164630,  0.021182,  0.012620,  0.258680,  -0.201409,
    0.222220,  0.196578,  0.089083,  0.272174,  -0.288781, 0.047273,  0.096519,  -0.335292,
    -0.219618, -0.184241, 0.295191,  0.079358,  0.082264,  -0.031300, 0.156684,  0.310552,
    0.032860,  0.196604,  -0.328252, -0.109921, 0.194562,  0.295983,  0.022079,  -0.280847,
    -0.294071, -0.289495, -0.134534, 0.330666,  -0.153552, 0.109457,  0.192390,  0.073499,
    -0.062785, 0.151377,  -0.274890, 0.189309,  0.002699,  0.128092,  -0.053156, -0.231388,
    0.168545,  0.273460,  0.088288,  -0.043432, 0.276770,  -0.075455, -0.293427, -0.180587,
    -0.182865, -0.072094, -0.323541, 0.306654,  -0.148821, 0.080067,  0.044465,  -0.024304,
    -0.202397, -0.281693, 0.102079,  0.194972,  0.193180,  0.228872,  -0.099665, -0.329573,
    -0.049129, 0.249594,  0.022178,  -0.015479, 0.299263,  -0.271264, -0.108101, -0.113162,
    0.237408,  0.323896,  0.157392,  -0.180503, -0.271027, -0.297726, 0.187956,  -0.013588,
    -0.115341, -0.316371, 0.021618,  0.233987,  -0.258406, -0.141398, 0.284652,  -0.277023,
    0.315950,  0.154568,  0.134105,  -0.195375, -0.266168, -0.025371, -0.120998, 0.079422,
    -0.067737, -0.063097, -0.078217, 0.214999,  0.135113,  -0.266339, 0.256171,  0.215628,
    -0.239610, 0.208423,  -0.230575, 0.177722,  -0.139507, 0.260229,  -0.259789, 0.302879,
    0.285941,  0.184594,  -0.194454, 0.294669,  0.021091,  0.015454,  -0.004602, 0.120961,
    0.241706,  0.236285,  -0.196304, 0.302021,  0.076882,  0.189117,  -0.116685, 0.112422,
    -0.044943, -0.130059, 0.019917,  -0.037795, 0.119427,  -0.202001, 0.024513,  -0.149006,
    -0.054365, -0.072444, 0.085153,  0.216087,  -0.079652, -0.019755, 0.310503,  0.109825,
    0.272801,  0.180549,  0.015819,  -0.326839, 0.324776,  0.304206,  0.180271,  -0.071734,
    -0.287441, 0.148311,  0.132180,  -0.141555, 0.002883,  -0.028199, -0.053619, 0.119952,
    0.224853,  -0.120981, -0.039658, -0.121284, 0.289031,  -0.144959, 0.327380,  -0.171671,
    -0.271323, -0.243973, -0.247159, -0.047945, 0.019335,  -0.065821, 0.024636,  -0.171407,
    0.156053,  0.100005,  -0.194905, -0.141919, -0.254321, 0.307566,  -0.033501, -0.115175,
    -0.131952, -0.318861, -0.208315, -0.169201, 0.063910,  0.093795,  0.225760,  0.127031,
    0.085842,  -0.335992, 0.202240,  -0.052739, -0.220212, 0.029896,  -0.309479, -0.095198,
    0.109286,  0.093956,  -0.103033, 0.269494,  -0.255956, 0.303255,  -0.113386, 0.187545,
    -0.215072, 0.245171,  0.037921,  -0.113818, 0.027520,  0.306074,  0.161896,  0.265935,
    -0.123444, 0.060512,  -0.264507, -0.186118, -0.287835, -0.281009, 0.310240,  0.016696,
    0.253754,  0.244881,  -0.055180, 0.307097,  0.067344,  0.180205,  0.058848,  -0.186856,
    -0.182624, 0.078358,  -0.005051, 0.170770,  0.190111,  -0.051056, -0.302458, 0.262773,
    -0.226577, 0.143387,  0.152583,  0.054047,  -0.186317, -0.248059, -0.127826, 0.192751,
    -0.235039, -0.075169, -0.303583, -0.220172, -0.275295, 0.322635,  -0.096088, 0.274293,
    -0.209345, 0.047279,  -0.233868, 0.238154,  0.069776,  0.272573,  0.185418,  -0.205060,
    -0.063892, 0.231886,  0.128982,  -0.109849, -0.267368, -0.106195, -0.178843, 0.288793,
    -0.272222, -0.057541, -0.195108, -0.024576, 0.037343,  0.245275,  -0.027597, -0.010948,
    0.089983,  0.054300,  0.299128,  0.315959,  0.025644,  0.127985,  0.215763,  0.018499,
    0.024995,  -0.085003, -0.285426, -0.125151, 0.021301,  -0.151228, -0.244394, 0.148759,
    -0.113077, -0.304890, 0.144412,  -0.068719, 0.243837,  -0.003817, 0.223799,  0.144771,
    0.211036,  0.128690,  0.040118,  0.074231,  -0.326981, 0.005970,  -0.123053, 0.263694,
    0.049936,  -0.090667, -0.284878, -0.241808, -0.132932, 0.323688,  -0.163617, 0.219806,
    0.039375,  0.006734,  -0.132357, 0.020812,  0.178102,  -0.084966, -0.041335, 0.282609,
    -0.100860, -0.312810, 0.200546,  0.061126,  0.222033,  -0.220214, -0.211112, -0.057185,
    -0.205923, -0.038082, -0.268536, 0.324757,  -0.199313, -0.106615, 0.102844,  -0.060952,
    -0.241771, 0.083499,  0.304740,  0.317062,  -0.282555, 0.192128,  -0.081314, 0.276245,
    0.023347,  -0.163245, 0.052634,  -0.285340, -0.254936, 0.089738,  0.126945,  -0.062452,
    0.222621,  -0.236463, 0.237913,  -0.095803, 0.103113,  -0.117902, -0.239626, -0.137627,
    0.267603,  0.276631,  0.025269,  -0.325502, 0.214334,  0.100046,  0.180697,  0.306845,
    0.053783,  0.052766,  0.092238,  0.274427,  0.227682,  0.151822,  0.309879,  0.154391,
    0.335223,  0.327054,  0.206579,  -0.096604, -0.251831, 0.269841,  0.100375,  -0.010818,
    0.281112,  -0.026544, -0.169658, -0.238864, -0.268871, 0.260529,  0.205329,  -0.163250,
    0.016370,  0.332520,  0.328942,  -0.196849, 0.024073,  -0.237551, -0.067100, -0.301354,
    0.233598,  0.184062,  0.137084,  0.263298,  0.327359,  -0.015391, -0.286332, -0.246007,
    -0.022841, 0.214417,  0.326202,  -0.215407, -0.296296, -0.193790, 0.265351,  -0.321800,
    -0.076642, -0.277840, 0.102708,  -0.105565, 0.039193,  -0.146444, -0.119452, -0.256708,
    -0.195284, 0.150040,  0.248251,  -0.059792, 0.310200,  0.312135,  0.262412,  0.030822,
    0.085853,  -0.151491, -0.140109, 0.043751,  0.328215,  -0.222455, 0.224891,  0.241100,
    -0.162277, 0.203187,  -0.088000, -0.156217, -0.063464, -0.105300, -0.170179, -0.300298,
    -0.176392, -0.121013, 0.034218,  0.187932,  -0.077394, 0.299009,  -0.107337, -0.000389,
    -0.039984, -0.228382, -0.280000, 0.180998,  -0.113535, 0.049164,  -0.106208, 0.112067,
    -0.068374, 0.180010,  0.289323,  0.150536,  -0.186538, 0.136018,  -0.315016, 0.214519,
    0.229494,  -0.110147, 0.151381,  -0.050971, -0.320349, -0.164939, -0.097438, -0.045410,
    -0.287295, -0.164514, 0.308367,  -0.081488, 0.097242,  -0.116911, 0.115461,  0.226179,
    0.148126,  0.190288,  -0.186140, 0.023026,  -0.163764, -0.032231, 0.099271,  -0.058058,
    0.241381,  -0.137235, -0.201852, -0.054211, -0.256025, 0.074739,  0.096030,  0.213839,
    -0.132639, -0.044923, 0.139603,  0.244088,  0.057168,  0.321295,  0.324620,  0.192148,
    -0.008944, 0.110292,  -0.036758, -0.178407, 0.095016,  0.012230,  0.143988,  0.224494,
    -0.139646, -0.135706, 0.236585,  0.271728,  0.162691,  -0.228716, -0.122124, -0.039340,
    -0.037031, 0.098472,  -0.001937, 0.270861,  0.292207,  0.196268,  0.199005,  -0.220268,
    -0.087751, -0.188192, 0.111335,  0.069461,  0.197908,  -0.320449, 0.208170,  0.292712,
    0.042167,  0.098119,  -0.176050, -0.067395, 0.338403,  -0.252967, -0.016532, 0.004017,
    0.058100,  -0.241245, -0.057456, 0.126705,  0.050439,  0.038668,  0.228037,  0.130544,
    -0.223547, 0.305314,  -0.272333, 0.032184,  -0.068602, 0.160994,  0.337670,  -0.295932,
    -0.042023, 0.149703,  0.005538,  0.259994,  0.208652,  0.038619,  0.074712,  -0.269076,
    0.028679,  -0.096502, -0.231331, -0.127132, 0.156453,  -0.312529, -0.261169, 0.307141,
    -0.273837, -0.182231, -0.251820, 0.031133,  -0.004541, -0.245800, 0.044364,  -0.279641,
    -0.245338, -0.016763, -0.065663, 0.294589,  0.255371,  0.096318,  0.218112,  -0.286043,
    0.136414,  -0.130275, 0.082199,  -0.320434, 0.017095,  -0.106964, -0.034120, -0.052112,
    0.072725,  0.206433,  -0.168407, 0.062652,  0.083549,  0.071595,  0.237828,  0.296742,
    -0.044391, -0.233220, -0.212916, 0.022822,  -0.144706, -0.033513, 0.309826,  -0.229338,
    -0.191117, 0.112550,  0.224295,  0.109154,  -0.253407, 0.178149,  -0.251347, 0.094086,
    -0.300466, -0.175732, 0.061597,  -0.085506, -0.219024, -0.255081, 0.305505,  0.081039,
    -0.126920, -0.050925, -0.179650, -0.041748, 0.045733,  -0.154243, 0.279569,  0.236778,
    -0.261208, -0.240748, -0.198195, -0.310904, -0.039550, 0.288522,  -0.197696, -0.065591,
    0.272841,  0.090267,  0.073348,  -0.277377, 0.250300,  0.041370,  -0.064207, -0.331490,
    -0.111809, -0.025558, -0.080104, 0.253548,  -0.152425, -0.141823, 0.108220,  -0.017963,
    0.271095,  0.057878,  -0.253718, 0.135264,  0.005496,  0.078187,  0.322295,  0.239218,
    0.101218,  0.211227,  -0.103433, -0.217510, -0.015891, -0.116366, -0.118967, 0.047480,
    0.160422,  -0.078430, -0.203478, 0.277653,  -0.043641, 0.194958,  0.108634,  -0.172260,
    -0.254094, 0.205748,  -0.294427, 0.043785,  -0.082132, 0.088803,  -0.175970, -0.259704,
    -0.132735, 0.012567,  -0.011065, 0.314508,  0.053884,  0.251516,  -0.032021, 0.117813,
    -0.014989, -0.125725, -0.146601, -0.181214, -0.026260, -0.197337, 0.212914,  0.274979,
    0.317105,  0.265027,  -0.112472, 0.034310,  0.276685,  0.063103,  -0.323009, 0.112251,
    0.219557,  0.078034,  0.061745,  -0.097114, -0.234440, 0.283535,  0.067449,  0.315041,
    0.028678,  0.140524,  0.070960,  -0.120458, 0.337060,  0.328945,  0.283927,  -0.167868,
    -0.223842, 0.307171,  0.133581,  0.066061,  -0.178596, -0.212022, -0.020351, -0.001661,
    -0.087473, -0.010114, 0.145763,  -0.156366, 0.031108,  0.168144,  -0.144311, -0.026231,
    0.037585,  -0.248599, 0.119101,  0.050263,  -0.229430, 0.077655,  -0.325554, -0.089849,
    0.255385,  0.048475,  0.093627,  -0.015001, 0.130765,  -0.102618, 0.016223,  -0.324078,
    0.228452,  0.033722,  0.150170,  0.301378,  -0.309580, -0.034455, 0.191239,  -0.195809,
    0.123668,  0.093835,  -0.268767, 0.312857,  -0.223860, 0.037169,  -0.228262, -0.076270,
    -0.182223, 0.059093,  -0.264204, -0.233092, 0.268360,  0.053924,  -0.292525, -0.097176,
    0.211291,  -0.046884, -0.041112, -0.288028, 0.012415,  0.139498,  -0.165706, 0.042974,
    0.246370,  0.013430,  -0.138224, 0.249924,  0.011794,  -0.025086, -0.285550, 0.109099,
    0.093900,  -0.027519, -0.275980, -0.224349, 0.196014,  0.128315,  0.057771,  -0.144173,
    0.159155,  -0.090535, 0.010127,  0.227708,  -0.080311, -0.308818, 0.071212,  -0.118361,
    0.020162,  0.024154,  -0.156938, -0.267347, 0.105072,  -0.133070, 0.052861,  -0.306946,
    -0.192818, 0.016633,  0.290943,  -0.124826, -0.327819, 0.283339,  0.242342,  0.241671,
    -0.181480, 0.308736,  0.260059,  0.005939,  -0.308713, 0.052444,  0.129419,  -0.252819,
    -0.213074, 0.315879,  -0.014975, 0.062528,  0.134864,  0.059398,  0.052057,  -0.254755,
    -0.216212, -0.180715, 0.126760,  -0.136964, -0.220910, 0.012427,  0.136353,  0.033576,
    -0.252255, -0.145052, 0.233052,  0.140806,  0.174575,  0.085776,  0.154656,  -0.016871,
    -0.233744, -0.216009, 0.238628,  0.087298,  -0.241400, -0.151599, 0.024735,  0.154939,
    -0.141476, -0.074443, -0.138731, 0.309434,  -0.256125, -0.040167, -0.039814, -0.179393,
    0.207947,  0.034585,  -0.102292, 0.200445,  -0.200551, 0.109184,  -0.042623, -0.093441,
    0.225437,  -0.247517, 0.191239,  -0.183936, -0.292218, -0.243937, 0.059105,  -0.211278,
    -0.004653, -0.001035, 0.327136,  0.167493,  0.336324,  0.246492,  0.206191,  -0.045398,
    -0.157781, 0.277374,  -0.180360, -0.229446, 0.133535,  -0.057479, 0.013852,  0.106369,
    -0.198523, 0.242331,  0.129322,  0.054218,  -0.276216, 0.051815,  -0.307442, -0.278683,
    0.021794,  -0.018040, -0.216654, 0.230822,  0.141247,  0.097146,  -0.319099, 0.061674,
    -0.032806, -0.023767, -0.107256, -0.261983, 0.091078,  0.162968,  0.129790,  0.006772,
    0.109666,  -0.105040, -0.176343, 0.087142,  0.307794,  0.238185,  -0.322538, -0.218391,
    0.088665,  -0.282554, 0.096832,  -0.083528, -0.136149, -0.237914, 0.106590,  0.155830,
    0.265057,  0.197760,  0.115488,  -0.317199, 0.296962,  0.216543,  0.151751,  -0.310494,
    0.209135,  -0.216644, 0.120447,  0.268813,  -0.258152, -0.090393, -0.279490, -0.108780,
    0.282069,  -0.024996, -0.021979, -0.251317, 0.067140,  -0.215352, -0.157838, -0.040884,
    -0.089071, -0.123724, 0.320521,  0.113409,  0.076108,  0.179754,  -0.169426, -0.244261,
    -0.125709, -0.220037, -0.125099, -0.098483, -0.072301, 0.200715,  -0.221584, -0.014763,
    0.176589,  -0.238222, 0.195954,  0.269021,  -0.095292, -0.218487, -0.299647, -0.260841,
    0.008695,  0.026899,  0.093931,  0.029543,  -0.119703, 0.311268,  0.073531,  0.003209,
    -0.136364, 0.038891,  0.302323,  0.332883,  -0.276093, 0.108379,  0.269497,  -0.316406,
    0.205877,  0.008229,  0.021119,  0.330183,  0.323059,  -0.250023, 0.047633,  0.045745,
    0.230411,  0.229082,  0.232659,  0.076846,  0.073880,  0.057101,  0.009587,  0.101492,
    0.300439,  -0.052466, 0.100513,  0.029833,  -0.258743, -0.175340, -0.002991, -0.212365,
    -0.280747, 0.057881,  -0.270944, 0.057648,  0.327913,  -0.159088, 0.314822,  -0.257639,
    0.089740,  0.099195,  0.017318,  -0.172852, -0.011366, -0.071707, -0.166224, 0.197126,
    0.298529,  -0.293122, -0.229979, -0.101181, 0.028086,  -0.108665, -0.018948, 0.120922,
    -0.105206, -0.118199, -0.255567, 0.206416,  -0.217168, -0.244286, -0.089626, -0.231514,
    -0.154719, -0.194374, -0.069915, -0.045331, 0.337103,  0.110267,  -0.001244, 0.021557,
    0.035612,  -0.254673, 0.247416,  -0.085234, 0.252949,  -0.057870, 0.109462,  -0.299340,
    0.001096,  -0.102683, -0.323379, -0.201003, -0.270821, 0.214807,  -0.270694, -0.021934,
    0.254400,  0.167478,  0.308318,  -0.167600, -0.193118, 0.214267,  0.222021,  -0.291342,
    0.123751,  -0.265657, -0.038063, -0.187079, 0.112352,  -0.085011, -0.326981, -0.187256,
    -0.147751, -0.161290, 0.291685,  0.057812,  -0.268156, 0.114461,  0.163853,  -0.014470,
    0.121038,  0.208704,  -0.153927, -0.000303, -0.017031, 0.288422,  0.128835,  0.230122,
    0.197482,  -0.305047, -0.233997, 0.094482,  -0.035821, 0.013989,  0.115678,  0.060907,
    -0.140348, 0.280647,  -0.102099, -0.301997, -0.065961, -0.223151, 0.283281,  -0.139184,
    -0.035148, -0.253133, -0.128589, 0.139742,  0.086884,  0.272660,  -0.224857, 0.144641,
    0.041905,  0.128002,  0.103756,  0.316452,  -0.122302, -0.066416, -0.110034, -0.071815,
    -0.013394, 0.045655,  0.214977,  0.320700,  -0.287160, -0.172986, -0.249102, 0.323345,
    -0.223531, -0.061514, 0.080803,  0.139525,  -0.183706, 0.095382,  -0.048812, -0.117803,
    -0.245705, -0.095349, -0.226575, -0.256491, -0.080630, -0.148870, -0.103977, -0.289866,
    0.073135,  -0.313147, 0.308911,  -0.072733, -0.192321, 0.216528,  -0.296040, 0.178478,
    0.051997,  -0.241352, -0.102692, 0.039864,  0.065850,  -0.011341, -0.232683, -0.302598,
    0.274787,  -0.306695, -0.036748, 0.277760,  0.015083,  -0.181413, 0.017417,  0.282140,
    0.082204,  0.227437,  0.093901,  0.090000,  -0.132138, -0.208006, -0.150802, -0.126860,
    -0.004270, 0.145013,  -0.010138, -0.137795, -0.273308, -0.253505, -0.240198, -0.296032,
    0.094140,  0.038288,  -0.180023, 0.082191,  0.245749,  -0.081561, 0.027750,  0.218730,
    -0.063871, -0.000337, -0.118845, -0.256469, -0.049174, 0.100911,  0.288249,  0.276311,
    0.108750,  0.203890,  -0.106214, -0.148164, 0.168868,  0.095432,  0.174877,  -0.056581,
    0.186295,  -0.232573, 0.079806,  0.118693,  0.121438,  -0.213870, -0.003129, 0.230708,
    -0.250313, -0.015243, 0.284912,  -0.117412, 0.136949,  -0.057270, 0.272351,  0.271579,
    0.205019,  -0.317365, 0.306670,  0.115721,  0.200438,  0.265766,  0.037844,  0.024636,
    -0.144742, 0.028547,  -0.281275, -0.136463, 0.034782,  -0.295451, 0.268813,  -0.149406,
    0.286930,  0.110006,  0.062029,  -0.097736, -0.141755, 0.074482,  0.093533,  0.310514,
    -0.281304, 0.083082,  -0.196218, 0.090825,  0.233123,  0.260281,  -0.120976, 0.164620,
    0.137772,  -0.308031, 0.230799,  0.168869,  -0.211445, -0.316891, 0.046221,  -0.303643,
    0.193258,  0.077302,  0.208596,  0.276006,  -0.217257, 0.064731,  -0.028584, 0.121116,
    -0.249724, 0.157694,  -0.172936, -0.156176, 0.241847,  0.035875,  -0.206317, 0.089549,
    0.147548,  -0.002798, 0.219697,  0.330145,  -0.007644, -0.085272, 0.276800,  0.299062,
    0.089855,  0.062278,  -0.289878, 0.214628,  -0.035421, 0.264802,  -0.334850, -0.179685,
    0.167091,  -0.090173, -0.085951, 0.114449,  0.324347,  0.128314,  0.232957,  -0.247771,
    -0.193410, -0.208883, 0.089601,  -0.316800, 0.099727,  -0.193312, 0.156848,  0.224345,
    -0.307086, 0.164423,  -0.310058, 0.087580,  0.296214,  0.046798,  -0.014818, 0.198492,
    0.202866,  -0.246431, -0.209914, -0.036275, -0.230870, -0.063952, 0.147529,  0.264734,
    -0.186728, -0.005054, 0.246063,  -0.088084, -0.143286, -0.111054, 0.123506,  0.298904,
    0.135658,  0.098976,  0.254353,  0.326495,  -0.209134, -0.175978, 0.122547,  -0.190771,
    0.015033,  0.087505,  0.134984,  -0.223748, -0.083794, 0.071067,  0.055538,  -0.273636,
    0.185037,  0.134916,  -0.286816, -0.093200, -0.042396, 0.248767,  0.281308,  0.025515,
    0.063361,  -0.272858, -0.052287, -0.123709, -0.170849, 0.080136,  0.292678,  -0.325745,
    -0.088900, -0.299414, -0.151639, 0.184269,  0.254501,  -0.211074, -0.333830, -0.238926,
    0.022177,  0.049478,  0.267195,  -0.157831, -0.137648, 0.157283,  -0.266567, 0.241676,
    0.234684,  -0.210259, -0.116181, 0.103035,  0.111715,  0.110189,  -0.169597, 0.180810,
    -0.250698, -0.191956, 0.267779,  0.085556,  -0.319207, -0.193661, 0.304440,  -0.279260,
    0.080211,  0.282781,  -0.206192, 0.159001,  0.130658,  -0.236596, 0.218061,  0.161141,
    -0.120798, 0.181936,  0.324190,  -0.124639, -0.209614, 0.263956,  0.142327,  0.139084,
    0.323440,  -0.210299, -0.134783, -0.054752, 0.128752,  -0.027381, -0.000872, 0.132699,
    -0.152265, -0.284139, -0.078658, 0.204874,  0.024959,  0.191981,  -0.108697, -0.218697,
    -0.004243, 0.141750,  0.028652,  -0.107369, -0.233726, 0.069600,  0.032728,  0.247115,
    -0.229886, -0.082249, 0.132486,  0.021713,  -0.228153, -0.130850, -0.170730, -0.219015,
    -0.122057, 0.088225,  -0.077620, -0.021727, 0.202044,  -0.149440, 0.069239,  0.040865,
    0.165576,  -0.012526, 0.054124,  0.140865,  -0.015155, -0.229471, -0.044029, -0.227376,
    0.321933,  -0.016289, -0.176851, 0.305218,  -0.177566, 0.329596,  0.100516,  -0.098407,
    -0.326115, -0.046608, -0.003051, -0.316774, -0.028234, 0.285411,  -0.325799, 0.216863,
    0.220738,  -0.272897, -0.228558, 0.192003,  -0.277626, -0.180470, 0.111455,  -0.129274,
    -0.233452, 0.289758,  -0.111621, -0.142864, 0.071061,  -0.135909, 0.041875,  -0.079198,
    -0.222859, -0.065608, 0.075544,  -0.073154, -0.155627, 0.284806,  -0.018907, -0.017116,
    0.206177,  0.155987,  -0.055254, -0.187577, -0.152469, -0.328690, -0.099027, -0.056501,
    0.329044,  -0.214845, -0.182783, 0.227193,  0.245140,  -0.331676, 0.084295,  -0.010413,
    0.056043,  0.052988,  -0.220832, 0.265491,  -0.033044, 0.014659,  0.298435,  -0.112511,
    0.301847,  0.070344,  0.257203,  -0.031224, 0.004551,  0.219111,  0.033225,  -0.159459,
    0.224693,  -0.203339, -0.031141, -0.225639, -0.136002, 0.007665,  0.119933,  0.054620,
    0.126893,  -0.137944, -0.319133, -0.260803, 0.218834,  0.222042,  -0.268056, -0.300401,
    -0.132536, -0.199631, 0.221102,  0.033862,  0.058268,  0.206423,  0.032664,  -0.027317,
    -0.321103, -0.329398, 0.230197,  -0.084972, -0.332635, 0.061274,  0.020830,  -0.129991,
    0.172300,  0.040458,  -0.021912, 0.275896,  -0.167382, 0.107106,  0.231936,  0.236175,
    0.015200,  -0.081141, 0.160992,  -0.053676, -0.098053, -0.049847, -0.042999, 0.278880,
    0.232661,  -0.195740, -0.306903, 0.130163,  0.080695,  -0.204896, -0.241966, -0.271459,
    -0.304453, -0.333534, 0.089481,  -0.235756, 0.064443,  -0.259934, 0.142876,  -0.239184,
    0.293332,  -0.232101, 0.022409,  0.008749,  0.285152,  0.014193,  -0.252969, -0.225345,
    0.068546,  0.121269,  0.063337,  -0.311197, -0.099574, -0.164727, 0.074102,  0.215220,
    -0.191220, 0.177087,  -0.291414, -0.095573, 0.304846,  -0.034595, 0.205672,  -0.072921,
    -0.125897, -0.183596, -0.191431, -0.002862, 0.050995,  0.220430,  0.269262,  -0.332584,
    -0.001452, -0.137745, 0.021709,  0.046320,  0.104051,  0.009626,  -0.234330, 0.085893,
    -0.211889, -0.201624, -0.331990, -0.146104, 0.114212,  -0.161635, -0.105511, -0.311928,
    -0.109922, 0.219923,  0.298377,  -0.096654, -0.213533, 0.107107,  0.034299,  -0.105120,
    0.123441,  0.132740,  -0.192576, 0.256529,  -0.296574, -0.089738, 0.006497,  0.035962,
    -0.322143, 0.159848,  0.140485,  0.316753,  0.046099,  0.044939,  0.244449,  -0.179960,
    0.192833,  0.301106,  -0.325669, 0.135281,  -0.111462, -0.052984, -0.009120, -0.187494,
    0.218534,  0.058831,  -0.301135, 0.257591,  -0.083999, -0.151304, -0.317209, -0.260118,
    0.088069,  0.205164,  0.215765,  0.152761,  -0.176770, 0.336973,  -0.156300, -0.243702,
    -0.162545, -0.249259, -0.312165, 0.011653,  -0.116948, 0.024807,  -0.131274, -0.125374,
    -0.158526, -0.129274, -0.046659, 0.249859,  -0.007921, 0.050187,  -0.274118, 0.015074,
    0.257593,  -0.035911, 0.276211,  0.229193,  -0.331484, 0.041230,  0.214713,  -0.287022,
    0.133477,  -0.246402, 0.138562,  -0.094987, -0.045689, 0.309401,  -0.205607, -0.192527,
    0.192775,  0.244456,  -0.016128, 0.037538,  -0.251305, -0.143507, 0.193918,  -0.251765,
    -0.185791, 0.230888,  0.124047,  -0.269392, -0.143836, -0.324560, 0.201976,  0.328505,
    0.134237,  -0.217589, 0.107647,  0.142247,  0.295875,  -0.153175, -0.121719, -0.102013,
    0.225382,  0.275619,  0.037595,  -0.139127, -0.050257, -0.315453, 0.239812,  0.082050,
    0.308585,  0.165761,  0.156794,  -0.321267, 0.267832,  0.210027,  -0.001306, 0.225770,
    -0.057664, -0.013876, -0.121031, 0.280954,  0.028831,  -0.272892, 0.175899,  -0.309096,
    -0.149323, -0.115995, 0.061864,  -0.243162, -0.001513, 0.141668,  0.011701,  -0.007072,
    0.268562,  0.239948,  -0.239737, 0.252583,  0.082255,  -0.140359, 0.088808,  -0.247845,
    -0.109363, -0.049962, -0.063136, 0.248850,  0.045834,  0.166729,  -0.152034, -0.050608,
    -0.003893, 0.185183,  0.250004,  0.100247,  -0.155263, 0.228151,  0.297274,  0.234075,
    0.130778,  -0.179242, 0.181967,  0.326256,  -0.208783, 0.023152,  -0.266569, -0.320773,
    0.183550,  0.034873,  0.242165,  -0.279534, -0.143609, 0.074408,  0.096454,  -0.229094,
    -0.111052, -0.031344, -0.311933, -0.142741, 0.127846,  -0.265300, -0.047530, 0.110396,
    0.123905,  -0.074057, 0.212377,  0.326524,  -0.142310, -0.154711, -0.078040, 0.103445,
    0.298407,  0.219132,  0.081274,  0.282443,  0.269070,  -0.294567, 0.233980,  0.215978,
    -0.222384, 0.236911,  -0.260829, -0.304909, 0.260987,  0.085214,  0.314601,  0.241790,
    -0.212788, 0.047769,  0.248167,  0.019202,  -0.044663, -0.039353, -0.333398, 0.310121,
    0.025977,  0.008465,  -0.133885, -0.240735, -0.305000, 0.010390,  0.128742,  -0.011579,
    -0.252872, 0.132112,  0.314823,  0.216435,  0.268466,  -0.146044, 0.160396,  -0.210905,
    -0.127062, -0.172352, -0.199470, -0.057007, -0.199791, -0.152238, 0.254401,  0.000678,
    -0.018517, -0.128747, 0.025467,  -0.094336, 0.306639,  -0.255072, -0.275513, 0.095590,
    0.142489,  0.201054,  0.159629,  0.205654,  0.166830,  0.237814,  0.259281,  0.101935,
    0.177455,  -0.014796, 0.101099,  -0.176028, 0.180361,  0.273139,  -0.031818, -0.091291,
    0.122733,  -0.101826, 0.054203,  0.100751,  -0.264215, 0.181363,  -0.032051, -0.229121,
    0.169055,  0.303420,  0.060246,  0.329379,  0.291230,  0.024724,  0.236918,  0.236965,
    0.167537,  0.269138,  -0.073090, -0.252174, 0.268625,  -0.096171, 0.161509,  -0.001086,
    0.318134,  0.012162,  0.119955,  -0.179397, -0.169139, 0.033803,  0.050031,  -0.038540,
    -0.300227, 0.168367,  0.286622,  -0.022509, 0.255431,  -0.251265, 0.181733,  -0.053458,
    -0.041444, -0.125014, -0.036875, -0.063694, -0.015257, -0.023342, -0.254979, -0.135071,
    0.321377,  0.236631,  -0.207540, -0.257298, 0.153696,  0.203784,  0.000088,  -0.197286,
    -0.048011, -0.204392, -0.232207, -0.110316, 0.308872,  0.023361,  0.119236,  -0.189618,
    -0.058065, 0.130965,  -0.165821, 0.155301,  -0.240105, 0.078686,  0.259067,  0.217633,
    -0.051519, 0.292899,  -0.125176, 0.213823,  0.028835,  -0.059853, -0.109237, 0.037648,
    -0.154259, -0.100595, -0.216200, -0.068424, 0.174453,  0.281976,  0.270292,  -0.201946,
    0.269724,  -0.329901, 0.335515,  0.258255,  -0.102205, -0.083325, 0.162032,  0.187977,
    0.190441,  0.146772,  -0.093544, -0.225738, -0.268507, 0.158121,  0.117561,  0.019679,
    -0.076451, -0.019469, -0.200982, 0.057919,  -0.028207, -0.309108, 0.075188,  0.011341,
    0.037602,  0.279642,  -0.024347, 0.195976,  -0.007166, -0.112374, 0.160398,  -0.280624,
    0.265634,  -0.017804, 0.300159,  0.082383,  0.257188,  0.019275,  -0.019259, -0.070773,
    -0.331597, -0.010875, 0.316576,  0.191350,  0.149115,  -0.189857, 0.110324,  0.043719,
    -0.291519, 0.025595,  0.280425,  -0.005784, 0.014607,  0.058830,  -0.016466, 0.224048,
    0.020436,  0.221785,  0.165751,  0.057435,  0.250654,  0.036412,  0.111875,  0.272210,
    -0.313457, -0.039577, -0.031541, -0.048626, 0.315849,  0.103182,  -0.198115, -0.038816,
    -0.033759, -0.249940, -0.000013, 0.006895,  -0.126943, -0.228920, -0.222130, 0.058528,
    0.180706,  0.160856,  0.083874,  0.210377,  -0.142493, 0.231961,  -0.222736, 0.109694,
    0.293580,  -0.060763, -0.053858, 0.038513,  -0.157923, -0.098453, -0.323769, -0.157714,
    -0.189030, 0.209941,  -0.017092, -0.330192, 0.282661,  0.294757,  -0.148291, -0.115794,
    -0.100217, 0.121440,  0.229162,  0.164248,  -0.202601, -0.132292, 0.183348,  0.178786,
    -0.134769, -0.228560, -0.281649, -0.074717, -0.180785, 0.134201,  0.103594,  0.108875,
    -0.304002, 0.297969,  0.013044,  -0.035179, 0.279502,  0.233489,  0.289829,  -0.151827};

static const float bias0[] = {
    0.017674,  -0.066139, -0.148653, 0.295161,  0.124501,  0.117386,  0.230411,  0.087764,
    -0.165374, -0.087784, -0.082854, -0.152472, 0.321374,  0.117763,  0.312600,  0.047458,
    -0.262899, 0.206746,  -0.023272, 0.183151,  -0.324873, -0.221719, -0.185452, -0.212485,
    0.212315,  -0.240650, 0.067591,  0.240443,  0.021479,  0.133047,  -0.041432, 0.293863,
    0.198721,  -0.217600, -0.003577, 0.218085,  -0.235547, 0.051171,  -0.291023, 0.181955,
    -0.192749, -0.296259, 0.021339,  -0.126362, -0.296654, 0.339652,  0.073781,  -0.334520,
    -0.049044, -0.215573, 0.323949,  -0.090333, -0.020628, 0.067156,  -0.316676, 0.009595,
    -0.103950, 0.302891,  -0.279055, -0.205730, -0.310331, -0.035475, -0.201432, -0.151972,
    0.265944,  0.326531,  0.254374,  -0.045695, -0.325161, -0.186459, 0.202170,  0.253760,
    -0.024346, -0.180994, -0.083835, -0.046213, -0.317667, 0.194949,  -0.325981, -0.073302,
    0.299370,  0.117308,  0.325865,  -0.000435, 0.295740,  -0.221733, -0.251191, -0.006647,
    0.292712,  -0.311576, 0.158217,  0.306255,  0.264651,  0.141877,  0.177646,  0.260213,
    -0.229100, 0.100270,  0.027048,  -0.017578, 0.195938,  -0.134571, 0.290595,  0.004864,
    0.009548,  0.034134,  -0.180258, 0.123520,  0.076567,  -0.333032, 0.304070,  0.162118,
    -0.105097, -0.283613, -0.104308, -0.190392, -0.245376, -0.213761, -0.000242, -0.085005,
    -0.142260, -0.018753, -0.294527, -0.053220, -0.007242, -0.145986, -0.240527, 0.049432,
    -0.138943, -0.005206, 0.177458,  -0.293985, 0.193001,  -0.112681, 0.286781,  0.069200,
    -0.203224, 0.046372,  -0.032766, -0.027073, -0.264242, 0.113407,  0.123041,  0.177976,
    -0.020056, 0.178472,  0.040727,  -0.235110, 0.209586,  -0.127583, -0.298630, -0.088345,
    0.004626,  -0.312741, -0.031827, -0.159272, -0.292507, 0.103366,  -0.169119, -0.213737,
    -0.205433, 0.071480,  0.283573,  0.137951,  0.178245,  -0.183518, 0.254929,  0.082628,
    0.153450,  0.205243,  0.009171,  -0.249582, -0.176558, 0.210997,  0.190370,  0.329732,
    -0.035195, -0.248271, -0.049406, -0.059444, -0.249324, -0.242776, -0.057484, -0.248208,
    0.165594,  -0.213509, -0.112853, -0.221134, 0.216567,  -0.020560, 0.315525,  -0.048647,
    -0.192373, -0.051792, 0.179625,  -0.131038, -0.196689, 0.329313,  -0.074839, -0.329850,
    -0.326310, 0.314939,  0.118956,  -0.136907, -0.213807, -0.260641, 0.187101,  -0.290845,
    -0.095364, -0.069521, -0.089895, 0.143244,  -0.180003, 0.081202,  0.229605,  0.158365,
    0.019651,  -0.202579, -0.062850, 0.029849,  0.322128,  -0.264572, 0.049019,  0.258535,
    0.228663,  -0.292533, 0.273140,  -0.132956, -0.201283, 0.318435,  -0.065347, 0.256934,
    -0.182923, -0.015995, -0.250342, -0.171646, 0.219897,  0.214293,  -0.210782, 0.311620,
    0.038896,  -0.326343, 0.131999,  0.074958,  -0.173089, 0.201148,  0.078313,  0.014099,
    -0.077683, 0.192318,  -0.308381, 0.189219,  -0.304397, 0.080254,  0.257069,  0.019963};

static const float weights1[] = {
    -0.012375, -0.018161, -0.027247, -0.016966, 0.043992,  0.017282,  -0.051802, -0.028800,
    -0.021805, 0.043169,  0.000865,  0.025977,  0.014825,  0.011094,  0.003586,  -0.002189,
    -0.058263, -0.001921, -0.051254, 0.024716,  0.049171,  0.021370,  -0.016820, -0.016852,
    0.017241,  -0.019176, 0.016696,  -0.026714, 0.023382,  -0.014816, 0.050373,  0.037431,
    -0.020898, 0.018047,  0.057321,  0.037014,  0.034961,  0.011108,  0.027335,  0.042305,
    0.060377,  -0.049951, -0.023046, -0.026170, -0.052264, 0.012497,  0.058023,  0.050863,
    0.038975,  0.004990,  0.030696,  -0.035127, 0.016510,  0.047553,  0.037066,  -0.033239,
    0.029840,  -0.049373, -0.046882, -0.042731, -0.031275, -0.036833, 0.028536,  -0.004849,
    0.050842,  -0.061714, 0.005753,  0.014772,  0.002357,  0.035452,  -0.056280, 0.003813,
    0.016691,  0.033495,  -0.009084, -0.004301, -0.017632, 0.046590,  -0.033402, 0.037418,
    -0.043239, 0.049421,  -0.003985, -0.050939, 0.024321,  -0.015555, 0.048707,  0.049244,
    -0.024496, 0.025147,  0.022238,  -0.054408, 0.019535,  -0.065919, -0.035618, -0.005280,
    -0.018095, -0.036247, 0.052520,  -0.010361, -0.037912, 0.005741,  -0.038675, -0.024275,
    -0.010936, 0.012824,  -0.040476, 0.054689,  -0.035479, 0.001373,  0.054802,  0.033732,
    0.012384,  0.038875,  0.026555,  -0.009574, 0.048474,  0.055533,  -0.047700, -0.059194,
    0.007727,  -0.031278, -0.030481, -0.045594, -0.012229, 0.005445,  -0.017821, -0.002749,
    -0.065974, -0.006674, 0.004435,  0.050538,  -0.046923, 0.025220,  -0.069286, -0.005540,
    -0.023356, 0.021421,  -0.003492, -0.020310, 0.008416,  0.022324,  -0.062202, -0.025327,
    -0.030255, -0.030094, 0.042340,  -0.013822, 0.042168,  0.032269,  0.017598,  -0.033054,
    -0.060447, -0.039855, -0.033480, -0.004913, -0.010638, -0.005116, -0.016308, -0.050224,
    -0.051046, -0.017133, -0.016809, 0.000607,  0.014765,  0.051758,  0.030088,  0.042943,
    0.032792,  -0.046216, -0.060344, -0.019856, -0.002721, -0.065541, 0.053354,  -0.016898,
    -0.020611, 0.036463,  0.043363,  -0.045737, 0.006916,  -0.020087, 0.030690,  0.053670,
    -0.015054, 0.006284,  0.005814,  -0.000677, 0.052907,  0.007529,  -0.051199, 0.001889,
    -0.039400, 0.056923,  0.046356,  0.022413,  0.047232,  -0.049896, -0.042714, 0.030390,
    0.038992,  -0.051572, 0.019842,  -0.045271, 0.014417,  0.054124,  -0.007739, -0.008727,
    -0.003279, 0.029097,  0.009100,  -0.047720, 0.046529,  0.027302,  -0.058369, -0.030576,
    0.014877,  -0.051501, -0.054570, -0.042210, -0.044990, -0.056380, -0.037298, 0.059261,
    -0.015547, -0.022399, 0.049220,  -0.005506, -0.007650, 0.051961,  0.025905,  -0.066614,
    -0.049965, -0.010250, 0.045571,  0.004105,  -0.050111, -0.056863, -0.017917, -0.005946,
    0.045338,  0.052058,  -0.039994, 0.035717,  -0.010655, 0.027622,  0.006144,  0.028320,
    -0.045931, -0.050495, -0.052866, 0.033851,  0.049497,  -0.044906, 0.048153,  0.056993,
    -0.016039, 0.049172,  -0.004246, 0.028317,  -0.065871, -0.044991, -0.018306, -0.030343,
    -0.012532, 0.023103,  -0.021436, 0.042724,  -0.063441, -0.020700, -0.043754, -0.024056,
    0.004664,  -0.019667, 0.011433,  0.043412,  0.052130,  0.008987,  -0.041250, -0.021351,
    0.040239,  0.020007,  0.036035,  0.044651,  -0.013750, -0.059328, -0.036483, -0.055930,
    -0.019286, 0.055230,  -0.018567, 0.043084,  0.053253,  0.018397,  -0.031871, 0.023195,
    -0.050962, 0.024479,  -0.065218, 0.051898,  0.022317,  -0.025622, 0.014690,  0.055425,
    -0.014471, 0.021704,  -0.022861, -0.054100, -0.030273, 0.060422,  -0.029666, 0.047369,
    0.047479,  -0.015257, 0.033493,  -0.017160, -0.000609, -0.028278, 0.035987,  -0.050904,
    -0.044620, 0.040667,  0.035798,  -0.003272, 0.037874,  0.053084,  -0.043716, 0.057768,
    -0.019484, 0.051937,  -0.055128, 0.010659,  -0.015459, 0.015925,  -0.041005, -0.046176,
    -0.050518, -0.023369, -0.036913, -0.040682, -0.047999, 0.041378,  0.015225,  -0.024793,
    -0.037939, -0.013276, -0.001353, 0.045580,  0.060689,  -0.024987, -0.031189, 0.019339,
    -0.031271, -0.017838, -0.061905, 0.027451,  0.007204,  0.006506,  0.004512,  0.061563,
    0.039628,  0.015316,  0.000754,  -0.008270, -0.011958, -0.002988, 0.013611,  0.020826,
    0.033130,  0.054459,  -0.035569, 0.044396,  -0.060010, 0.037738,  0.011800,  0.028258,
    0.039267,  -0.048148, 0.033899,  -0.036388, 0.017199,  0.051744,  0.050529,  0.003167,
    -0.009831, -0.015317, 0.042071,  -0.047567, -0.038623, 0.016856,  -0.047727, -0.020847,
    -0.006338, 0.010881,  -0.057894, 0.045422,  0.050050,  -0.020997, -0.026888, -0.034115,
    0.020176,  -0.018480, 0.046115,  -0.034661, -0.019561, -0.007074, -0.049852, 0.004435,
    -0.012996, -0.003827, 0.053120,  0.045491,  0.053052,  -0.012373, 0.036894,  -0.052407,
    0.029372,  -0.050384, 0.000066,  0.029090,  -0.029922, 0.018187,  -0.058203, -0.026904,
    0.017324,  0.009543,  0.017761,  0.023026,  -0.042727, 0.025990,  -0.054095, -0.021444,
    0.033151,  -0.059403, 0.011281,  0.068977,  0.017814,  -0.041862, -0.019641, -0.023820,
    0.046464,  0.016784,  0.037017,  -0.020070, 0.055945,  -0.037492, 0.051975,  -0.010400,
    0.050672,  -0.032764, 0.003358,  -0.012992, 0.011600,  -0.020572, -0.045219, 0.000992,
    0.040578,  -0.029397, -0.041028, -0.003792, 0.012954,  -0.035771, -0.009388, 0.062670,
    -0.052160, -0.029155, -0.038981, -0.064631, -0.051638, -0.005520, 0.056372,  -0.065933,
    -0.028163, 0.045562,  -0.012790, -0.002372, -0.010311, 0.032221,  0.050637,  -0.041176,
    -0.035481, -0.011139, 0.029762,  0.003847,  -0.029945, 0.049615,  -0.063310, -0.002770,
    -0.031505, -0.035681, -0.058952, 0.009329,  -0.002229, 0.032285,  -0.043540, -0.010806,
    0.051217,  -0.028406, 0.032230,  -0.057826, -0.007914, 0.018117,  -0.023976, 0.010216,
    0.066251,  -0.035882, -0.048978, 0.021184,  0.033062,  0.033003,  -0.061876, 0.041585};

static const float bias1[] = {0.059359, -0.024659};

static void forward(const float* input, float* output, float* arr) {
  float* curr = arr;

  // Layer 0
  for (int i = 0; i < 256; i++) {
    float sum = 0.0f;
    for (int j = 0; j < 9; j++) {
      sum += input[j] * weights0[i * 9 + j];
    }
    curr[i] = sum + bias0[i];
  }

  // Output Layer
  for (int i = 0; i < 2; i++) {
    float sum = 0.0f;
    for (int j = 0; j < 256; j++) {
      sum += curr[j] * weights1[i * 256 + j];
    }
    output[i] = sum + bias1[i];
  }
}

atomic_t start_loc = ATOMIC_INIT(0);

typedef struct lengths {
  u64 segments;
} queue_lengths;

queue_lengths* qs;

int fstore_get_map_array_start(u64 map_name, size_t key_size, size_t value_size,
                               size_t num_elements, void** map_ptr);

int fstore_put_map_array(u64 map_name);

typedef struct io_history_data {
  u64 ts;
  u64 ios_4k;
  u64 latency_ns;
  u64 valid;
} io_history_data_t;

typedef struct to_sort {
  __u64 ts;
  __u64 ios_4k;
  __u64 latency_ns;
} sortable_t;

static void read_data(io_history_data_t* data_buffer, u64* head_ptr, sortable_t* buffer, int len) {
  __u64 start = READ_ONCE(*head_ptr);
  __u64 trials = MIN(len * 3, BUFFER_SIZE >> 1);
  for (int c = 0; c < len && trials > 0; trials--) {
    start = (start - 1) % BUFFER_SIZE;
    io_history_data_t* point = data_buffer + start;
    cmpxchg64_acquire(&point->valid, 1, 2);
    buffer[c].latency_ns = point->latency_ns;
    buffer[c].ios_4k = point->ios_4k;
    buffer[c].ts = point->ts;
    if (cmpxchg64_release(&point->valid, 2, 1) == 2) {
      c++;
    }
  }
}

static int sort_data(const void* a, const void* b) {
  sortable_t sa = *(const sortable_t*)a;
  sortable_t sb = *(const sortable_t*)b;
  return sa.ts - sb.ts;
}

__u64* head[3] = {NULL, NULL, NULL};
io_history_data_t* histories[3] = {NULL, NULL, NULL};

static void get_data_into_float(int index, float* input) {
  sortable_t history[4];
  read_data(histories[index], head[index], history, 4);
  sort(history, 4, sizeof(sortable_t), sort_data, NULL);
  for (int i = 0; i < 4; i++) {
    input[i] = (float)(history[i].ios_4k);
    input[4 + i] = (float)(history[i].latency_ns / 1000);
  }
}

static int infer(struct r1conf* conf, struct r1bio* r1_bio) {
  PRINT_DEBUG("start of infer");
  unsigned int raid_disks = conf->raid_disks;
  unsigned int start = ((unsigned int)atomic_inc_return(&start_loc)) % raid_disks;

  struct md_rdev* rdev;

  unsigned int curr = start;
  kernel_fpu_begin();
  float input[INPUT_SIZE];
  for (unsigned int i = 0; i < raid_disks; i++) {
    PRINT_DEBUG("start of loop");
    float output[OUTPUT_SIZE];
    float arr[MAX_LAYER_SIZE];
    curr = (start + i) % raid_disks;

    if (r1_bio->bios[curr] == IO_BLOCKED) {
      continue;
    }

    rdev = conf->mirrors[curr].rdev;
    if (!rdev_readable(rdev, r1_bio)) {
      continue;
    }
    if (rdev->bdev == NULL) {
      continue;
    }
    u32 index = select(disk_devt(rdev->bdev->bd_disk));
    if (index > 2) {
      pr_err("Extremely bad error has occurred\n");
      kernel_fpu_end();
      return curr;
    }

    ktime_t start = ktime_get();
    PRINT_DEBUG("reading data");
    input[0] = READ_ONCE(qs[index].segments);
    get_data_into_float(index, input + 1);
    PRINT_DEBUG("forward pass");
    forward(input, output, arr);
    ktime_t end = ktime_get();
    atomic64_add(end - start, &duration);
    atomic64_inc(&times);
    PRINT_DEBUG("decision");
    if ((output[0] - output[1]) > 0) {
      break;
    }
  }
  kernel_fpu_end();
  return curr;
}

__u64 map_id[7];

int __init init_module(void) {
  if (convert8byteStringHash(QUEUE, map_id))
    return -EINVAL;
  int err = fstore_get_map_array_start(map_id[0], 4, sizeof(queue_lengths), 3, (void**)&qs);
  if (err != 0)
    return err;

  if (convert8byteStringHash(MPSO0, map_id + 1))
    return -EINVAL;
  err = fstore_get_map_array_start(map_id[1], 4, sizeof(io_history_data_t), BUFFER_SIZE,
                                   (void**)&histories[0]);
  if (err != 0)
    return err;

  if (convert8byteStringHash(MPSO1, map_id + 2))
    return -EINVAL;
  err = fstore_get_map_array_start(map_id[2], 4, sizeof(io_history_data_t), BUFFER_SIZE,
                                   (void**)&histories[1]);
  if (err != 0)
    return err;

  if (convert8byteStringHash(MPSO2, map_id + 3))
    return -EINVAL;
  err = fstore_get_map_array_start(map_id[3], 4, sizeof(io_history_data_t), BUFFER_SIZE,
                                   (void**)&histories[2]);
  if (err != 0)
    return err;

  if (convert8byteStringHash(MPH0, map_id + 4))
    return -EINVAL;
  err = fstore_get_map_array_start(map_id[4], 4, sizeof(__u64), 1, (void**)&head[0]);
  if (err != 0)
    return err;

  if (convert8byteStringHash(MPH0, map_id + 5))
    return -EINVAL;
  err = fstore_get_map_array_start(map_id[5], 4, sizeof(__u64), 1, (void**)&head[1]);
  if (err != 0)
    return err;

  if (convert8byteStringHash(MPH0, map_id + 6))
    return -EINVAL;
  err = fstore_get_map_array_start(map_id[6], 4, sizeof(__u64), 1, (void**)&head[2]);
  if (err != 0)
    return err;

  __u64 xor_reader = 0;
  for (int i = 0; i < BUFFER_SIZE; i++) {
    xor_reader ^= READ_ONCE(histories[0][i].valid);
    xor_reader ^= READ_ONCE(histories[1][i].valid);
    xor_reader ^= READ_ONCE(histories[2][i].valid);
  }

  printk("Inserted: %lld\n", xor_reader);

  ml_choose_best_rdev_raid1 = infer;
  return 0;
}

void __exit cleanup_module(void) {
  for (int i = 0; i < sizeof(map_id) / sizeof(__u64); i++) {
    fstore_put_map_array(map_id[i]);
  }
  ml_choose_best_rdev_raid1 = NULL;
  pr_info("Goodbye, Inference: %lldns\t%lld times\n", READ_ONCE(duration), READ_ONCE(times));
}

MODULE_LICENSE("GPL");
