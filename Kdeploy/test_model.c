#include <linux/module.h>
#include <linux/module.h> /* Needed by all modules */
#include <linux/printk.h> /* Needed for pr_info() */
#include <asm/fpu/api.h>
#include <linux/timex.h>
#include <linux/delay.h>
#include <linux/vmalloc.h>
#define MAX_LAYER_SIZE 32
#define INPUT_SIZE 2
#define OUTPUT_SIZE 2

const float sqrt_pi = 1.7724538509055159;
const float sqrt_pi_div_2 = 0.8862269254527579;


/* Function prototypes */
float sfma(float a, float b, float c);
float my_erf(float a);
void sigmoid(float* input, float* output, int size);
void matrix_vec(float* mat, float* vec, float* output, int matrix_dim, int shared_dim);
void vector_sum(float* vec1, float* vec2, float* output, int size);
void fast_tanh(float* input, float* output, int size);
void hadamard_product(float* vec1, float* vec2, float* output, int size);
void printArr(float* arr, int n);

float sfma(float a, float b, float c) {
  return (a * b) + c;
}

float my_erf(float a) {
  float r, s, t, u, v, w;

  t = (a >= 0) ? a : -a;
  s = a * a;
  if (t >= 1.0) {
    // max ulp error = 0.97749 (USE_EXPM1 = 1); 1.05364 (USE_EXPM1 = 0)
    float sb0[3] = {-5.6271698391213282e-18, t, 4.8565951797366214e-16};
    float sb1[3] = {-1.9912968283386570e-14, t, 5.1614612434698227e-13};
    float sb3[3] = {-9.4934693745934645e-12, t, 1.3183034417605052e-10};
    float sb5[3] = {-1.4354030030292210e-09, t, 1.2558925114413972e-08};
    float sb7[3] = {-8.9719702096303798e-08, t, 5.2832013824348913e-07};
    float sb9[3] = {-2.5730580226082933e-06, t, 1.0322052949676148e-05};
    float sb11[3] = {-3.3555264836700767e-05, t, 8.4667486930266041e-05};
    float sb13[3] = {-1.4570926486271945e-04, t, 7.1877160107954648e-05};
    float nX[8] = {sb0[0], sb1[0], sb3[0], sb5[0], sb7[0], sb9[0], sb11[0], sb13[0]};
    float nY[8] = {sb0[1], sb1[1], sb3[1], sb5[1], sb7[1], sb9[1], sb11[1], sb13[1]};
    float nZ[8] = {sb0[2], sb1[2], sb3[2], sb5[2], sb7[2], sb9[2], sb11[2], sb13[2]};
    float nr[8];
    for (int i = 0; i < 8; i++)
    	nr[i] = sfma(nX[i], nY[i], nZ[i]);
    float b0 = nr[0];
    float b1 = nr[1];
    float b3 = nr[2];
    float b5 = nr[3];
    float b7 = nr[4];
    float b9 = nr[5];
    float b11 = nr[6];
    float b13 = nr[7];

    float b2 = sfma(b0, s, b1);
    float b4 = sfma(b2, s, b3);
    float b6 = sfma(b4, s, b5);
    float b8 = sfma(b6, s, b7);
    float b10 = sfma(b8, s, b9);
    float b12 = sfma(b10, s, b11);
    float b14 = sfma(b12, s, b13);
    float b15 = sfma(4.9486959714661590e-04, t, -1.6221099717135270e-03);
    float b16 = sfma(b14, s, b15);
    float b17 = sfma(1.6425707149019379e-04, t,
                     1.9148914196620660e-02); //  0x1.5878d80188695p-13, 0x1.39bc5e0e9e09ap-6
    float b18 = sfma(b16, s, b17);
    float b19 = sfma(b18, t, -1.0277918343487560e-1); // -0x1.a4fbc8f8ff7dap-4
    float b20 = sfma(b19, t, -6.3661844223699315e-1); // -0x1.45f2da3ae06f8p-1
    float b21 = sfma(b20, t, -1.2837929411398119e-1); // -0x1.06ebb92d9ffa8p-3
    float b22 = sfma(b21, t, -t);
  } else {
    // max ulp error = 1.01912
    r = -7.7794684889591997e-10;            // -0x1.abae491c44131p-31
    r = sfma(r, s, 1.3710980398024347e-8);  //  0x1.d71b0f1b10071p-27
    r = sfma(r, s, -1.6206313758492398e-7); // -0x1.5c0726f04dbc7p-23
    r = sfma(r, s, 1.6447131571278227e-6);  //  0x1.b97fd3d9927cap-20
    r = sfma(r, s, -1.4924712302009488e-5); // -0x1.f4ca4d6f3e232p-17
    r = sfma(r, s, 1.2055293576900605e-4);  //  0x1.f9a2baa8fedc2p-14
    r = sfma(r, s, -8.5483259293144627e-4); // -0x1.c02db03dd71bbp-11
    r = sfma(r, s, 5.2239776061185055e-3);  //  0x1.565bccf92b31ep-8
    r = sfma(r, s, -2.6866170643111514e-2); // -0x1.b82ce311fa94bp-6
    r = sfma(r, s, 1.1283791670944182e-1);  //  0x1.ce2f21a040d14p-4
    r = sfma(r, s, -3.7612638903183515e-1); // -0x1.812746b0379bcp-2
    r = sfma(r, s, 1.2837916709551256e-1);  //  0x1.06eba8214db68p-3
    r = sfma(r, a, a);
  }
  return r;
}

void sigmoid(float* input, float* output, int size) {
  for (int i = 0; i < size; i++) {
    output[i] = my_erf(sqrt_pi_div_2 * input[i]);
  }
}

void matrix_vec(float* mat, float* vec, float* output, int matrix_dim, int shared_dim) {
  for (int i = 0; i < matrix_dim; i++) {
    for (int j = 0; j < shared_dim; j++) {
      output[i] += (mat[i * shared_dim + j] * vec[j]);
    }
  }
}

void vector_sum(float* vec1, float* vec2, float* output, int size) {
  for (int i = 0; i < size; i++) {
    output[i] += vec1[i] + vec2[i];
  }
}

void fast_tanh(float* input, float* output, int size) {
  for (int i = 0; i < size; i++) {
    float x = input[i];
    float x2 = x * x;
    float a = x * (135135.0f + x2 * (17325.0f + x2 * (378.0f + x2)));
    float b = 135135.0f + x2 * (62370.0f + x2 * (3150.0f + x2 * 28.0f));
    output[i] = a / b;
  }
}

void hadamard_product(float* vec1, float* vec2, float* output, int size) {
  for (int i = 0; i < size; i++) {
    output[i] += vec1[i] * vec2[i];
  }
}

#define LSTM_INPUT_SIZE  2
#define LSTM_HIDDEN_SIZE 64
#define PARTS            4

typedef struct lstm {
  // weights
  float weight_ih_l[PARTS * LSTM_HIDDEN_SIZE * LSTM_INPUT_SIZE];
  float weight_hh_l[PARTS * LSTM_HIDDEN_SIZE * LSTM_HIDDEN_SIZE];
  float bias_ih_l[PARTS * LSTM_HIDDEN_SIZE];
  float bias_hh_l[PARTS * LSTM_HIDDEN_SIZE];
  // inputs
  float input[LSTM_INPUT_SIZE];
  float h_0[LSTM_HIDDEN_SIZE];
  float c_a[LSTM_HIDDEN_SIZE];
  // outputs
  float c_b[LSTM_HIDDEN_SIZE];
  float output[LSTM_HIDDEN_SIZE];
  float* c_0;
  float* c_1;
} lstm;

static const float weights0[] = {};
/*
static const float weights0[] = {
-0.014877, -0.019376, -0.023966, 0.096509, -0.003976, -0.024883, 0.133627,
-0.113646, 0.142315, -0.026203, -0.017466, -0.035875, -0.099793, 0.064781,
-0.023882, 0.052225, -0.048467, -0.032827, 0.053206, 0.000896, 0.097854,
-0.067527, -0.119096, -0.018321, -0.012380, -0.146358, -0.034189, -0.049018,
0.080410, 0.085270, -0.006766, -0.008907, -0.013079, 0.080073, -0.091430,
-0.165641, -0.027748, 0.112704, -0.142936, 0.117196, -0.026705, 0.077009,
0.030772, -0.057013, -0.069598, -0.094981, -0.044342, -0.164474, 0.021303,
0.114371, 0.122607, -0.024981, 0.006809, -0.002901, -0.089354, -0.081500,
0.028129, 0.139262, 0.088509, 0.037160, -0.126141, 0.014530, 0.146482, 0.150524,
0.043869, -0.091619, -0.016777, -0.075805, -0.034614, 0.062935, 0.086713,
0.077194, 0.022895, -0.076620, 0.130096, 0.054196, -0.011904, 0.061514,
0.053315, -0.040562, -0.065638, 0.085557, 0.056235, -0.107648, 0.118432,
0.027423, -0.102550, 0.004769, 0.079698, 0.026521, 0.066444, -0.020127,
-0.099190, 0.077221, -0.051621, -0.184206, 0.113624, -0.113151, 0.065511,
0.110754, -0.051169, -0.066869, -0.130267, 0.008651, 0.082600, 0.073014,
-0.122290, 0.099330, 0.015661, -0.097045, 0.103802, -0.042206, 0.080808,
0.036766, 0.054759, -0.165133, 0.041182, -0.032314, -0.138111, 0.046886,
-0.107871, 0.080645, -0.122254, 0.048297, -0.033503, -0.161507, 0.023457,
0.069425, -0.058843, -0.074460, 0.072611, 0.118166, 0.075316, 0.110079,
0.042124, -0.136473, 0.094004, -0.041219, 0.030448, -0.062219, -0.053764,
0.122619, -0.024188, 0.083415, -0.028346, -0.035267, 0.116473, -0.025253,
0.136235, 0.066313, -0.089615, -0.020390, -0.049429, -0.012391, -0.028031,
-0.152254, -0.098363, -0.052302, -0.035883, -0.027553, 0.107937, -0.045400,
-0.211351, -0.007441, -0.045615, -0.078360, -0.021454, 0.035071, 0.097768,
0.125223, 0.119341, 0.037609, 0.035241, -0.115742, 0.019221, -0.121051,
-0.032559, -0.058924, -0.078572, -0.090243, -0.031390, -0.132555, -0.155922,
-0.089069, 0.011156, 0.040847, -0.032848, 0.054449, -0.048268, 0.068055,
0.002595, -0.046249, 0.054032, 0.051632, -0.113664, 0.060720, -0.065350,
0.109362, -0.014661, -0.030873, 0.070417, -0.090904, -0.041329, 0.051221,
-0.076383, 0.021407, 0.025785, 0.017631, 0.105232, -0.120767, 0.060325,
0.086173, 0.141230, 0.047496, -0.005580, -0.075313, -0.089591, -0.153014,
-0.042536, -0.068046, 0.011519, -0.062241, -0.085249, -0.139846, 0.083448,
-0.053698, -0.050462, 0.057069, 0.016464, 0.080978, -0.058694, -0.037470,
-0.049622, 0.144824, 0.034311, 0.127305, 0.033946, -0.047376, -0.010628,
-0.068678, 0.008341, 0.135938, -0.039772, -0.052849, 0.064853, -0.017773,
-0.080512, 0.049870, 0.002596, 0.026794, -0.045356, 0.111388, 0.057651,
0.038595, 0.148946, 0.023929, -0.064168, 0.056061, 0.046943, 0.091036, 0.073860,
0.055327, 0.064128, -0.060220, 0.072569, -0.081046, -0.025066, 0.144912,
-0.046173, -0.035012, 0.015300, -0.103572, 0.088142, 0.109501, 0.111144,
-0.029374, -0.048876, -0.042822, -0.148227, -0.082349, -0.046043, 0.085247,
0.045983, -0.010217, -0.172362, 0.058573, -0.085470, 0.070318, 0.004939,
-0.050648, 0.036848, -0.079775, 0.116158, -0.030194, -0.027235, 0.074129,
0.028016, 0.027828, 0.107531, 0.057975, 0.003090, -0.112485, -0.068678,
-0.075814, -0.019804, 0.116893, 0.100924, 0.039822, -0.121603, -0.131015,
0.056521, -0.105101, 0.090277, 0.092774, 0.134545, 0.032381, 0.035599,
-0.069149, 0.034611, 0.101274, -0.129472, 0.126894, -0.106343, 0.032361,
0.000460, 0.026886, 0.064062, 0.058400, 0.127318, -0.059324, -0.072350,
-0.095067, -0.071770, 0.145929, -0.042568, 0.233974, 0.245433, 0.001534,
-0.034763, -0.065020, 0.051279, -0.015468, 0.034253, 0.046490, -0.064096,
-0.100061, -0.014160, 0.063010, 0.058228, 0.032991, 0.119445, 0.096115,
0.137456, -0.112700, -0.000353, -0.139552, -0.091101, 0.060659, -0.078926,
-0.013182, 0.077194, -0.018699, 0.004032, -0.074979, 0.009756, -0.061973,
-0.050630, -0.145357, 0.186726, -0.055760, -0.064661, 0.030929, -0.029514,
-0.090639, 0.057052, 0.071832, 0.071348, 0.036000, 0.031453, 0.024552,
-0.047531, 0.213381, 0.022167, 0.171877, -0.026999, -0.015858, -0.015075,
-0.041035, -0.057449, 0.114853, 0.125323, -0.123369, 0.047341, -0.054181,
0.057789, 0.081527, -0.015842, 0.136120, 0.016049, 0.129938, -0.025862,
-0.010809, -0.002988, 0.015425, 0.068258, 0.127719, 0.078856, 0.078279,
0.064461, -0.121498, 0.051195, -0.092272, -0.120326, -0.046873, -0.104488,
-0.030909, 0.107029, -0.001044, -0.072703, 0.077372, 0.028903, 0.130237,
-0.031163, -0.076488, -0.088723, 0.072075, -0.060490, -0.001516, -0.142447,
0.016144, -0.121310, -0.123182, -0.111120, -0.089037, 0.137289, -0.031287,
0.042589, -0.128613, -0.098145, -0.166515, 0.049335, 0.133950, 0.014497,
-0.005331, -0.107088, 0.083064, 0.086388, 0.165443, 0.167657, -0.186428,
0.025868, -0.140004, -0.081622, -0.131862, -0.149100, 0.093776, 0.087944,
0.000902, -0.008330, -0.050386, 0.035136, -0.055965, -0.122955, -0.060145,
-0.094130, 0.011693, -0.019428, 0.073053, -0.039716, -0.055268, 0.124316,
-0.051848, 0.127085, 0.009497, 0.032612, 0.022997, -0.054331, -0.086282,
0.000555, 0.040468, 0.026229, 0.069225, 0.126271, 0.022663, -0.096706,
-0.107819, 0.004367, -0.087303, 0.148041, -0.072129, -0.036331, 0.028071,
0.042405, 0.053529, 0.134962, 0.136057, -0.004949, -0.095538, 0.020117,
0.006317, -0.018267, 0.086001, 0.191674, 0.033477, -0.152409, -0.000593,
0.030253, -0.128943, 0.025428, 0.102633, 0.041643, -0.148614, -0.060355,
-0.181266, -0.046444, -0.019333, -0.146500, -0.003106, -0.154331, 0.107059,
-0.208402, -0.040161, -0.017341, -0.044248, 0.200081, -0.119858, -0.124141,
-0.001094, -0.067850, -0.032302, -0.106015, -0.040327, 0.017914, 0.064005,
0.089466, 0.042817, 0.025904, 0.078607, 0.007291, 0.061837, -0.130070, 0.052251,
0.088692, 0.034149, -0.174310, -0.089539, 0.077674, 0.052566, -0.022586,
-0.141706, -0.035545, -0.150463, -0.006695, -0.038966, 0.046176, -0.116545,
0.023807, -0.049576, 0.114429, 0.157950, 0.012828, -0.145795, -0.110876,
-0.071423, 0.078178, 0.106139, 0.087920, 0.112978, -0.122470, -0.145802,
0.064512, -0.057007, 0.252025, -0.095679, -0.110838, -0.165726, -0.122198,
0.129190, -0.040293, -0.090489, 0.016586, -0.195479, 0.067264, 0.025964,
-0.130181, 0.016346, 0.097007, 0.029047, 0.067504, -0.004521, -0.030214,
-0.026761, -0.035451, 0.041289, 0.098471, -0.080955, 0.131165, -0.078256,
0.079177, 0.095831, -0.115832, -0.043799, 0.209833, 0.039815, -0.110936,
-0.081451, -0.092730, 0.024465, 0.139202, -0.104516, 0.043548, 0.212515,
-0.119264, 0.090702, 0.123782, 0.201022, 0.023756, -0.172328, -0.007457,
0.035614, -0.092946, 0.060706, 0.047407, -0.009292, 0.088998, 0.098323,
0.003879, -0.108606, -0.063992, 0.031699, 0.035268, 0.116359, 0.036174,
0.105175, 0.075027, -0.095592, -0.140268, -0.044348, -0.093683, -0.016976,
-0.119557, -0.082337, -0.072157, -0.037977, -0.088364, -0.086147, -0.062391,
0.004524, 0.035234, -0.019987, -0.088193, 0.067386, 0.034788, 0.148251,
-0.044147, -0.049323, 0.029632, 0.044904, -0.013630, -0.098421, 0.108457,
-0.021561, -0.095959, 0.019209, 0.066038, -0.162355, 0.141117, 0.013821,
-0.023196, -0.035808, 0.072748, 0.056666, -0.049921, 0.071678, -0.099795,
-0.070496, -0.005730, 0.035982, 0.114167, -0.018330, -0.014291, 0.005443,
-0.179472, -0.043160, 0.050182, 0.020347, 0.134051, -0.037436, -0.006687,
0.094939, -0.062457, 0.076586, -0.081469, 0.073391, -0.036167, 0.045458,
0.029146, 0.080985, -0.148185, -0.056584, -0.018027, -0.049915, 0.057089,
-0.012385, 0.159202, -0.202621, 0.137285, 0.175058, -0.025206, -0.143540,
-0.265350, 0.263980, -0.081247, -0.052973, 0.066173, 0.009569, 0.173855,
-0.218974, -0.182549, 0.008497, 0.104704, -0.043869, -0.067432, 0.034417,
-0.152601, -0.038539, -0.005660, -0.065217, 0.090279, 0.043430, 0.018403,
0.014266, -0.001165, -0.192888, -0.042067, 0.046817, -0.263113, -0.012589,
0.330518, 0.044520, -0.117631, -0.183528, 0.151645, -0.122350, 0.082923,
-0.089997, -0.008342, -0.043261, 0.025273, -0.275226, 0.609436, 0.146605,
-0.154086, -0.149670, -0.024505, 0.093760, 0.409579, 0.517587, 0.056728,
0.112092, -0.026085, -0.396227, 0.038918, -0.108877, 0.109735, -0.041436,
-0.221441, -0.312799, -0.031517, 0.006283, 0.073348, 0.131753, -0.051869,
0.150971, -0.003443, 0.015233, 0.040240, -0.124039, -0.053751, 0.038702,
-0.081047, 0.060368, -0.077401, 0.012292, -0.107753, 0.145137, -0.036524,
0.034673, 0.017049, -0.152880, -0.064181, 0.020199, 0.066559, 0.043176,
-0.106777, 0.055289, 0.085644, -0.091870, -0.073999, 0.188606, 0.035375,
0.046428, -0.018476, 0.106730, -0.086136, 0.023206, -0.054991, -0.045793,
0.093673, 0.065098, 0.009104, 0.086649, -0.050870, -0.101508, 0.011353,
-0.063309, -0.077335, 0.020623, 0.063817, 0.200246, 0.082250, -0.126330,
0.079217, -0.114229, 0.082131, 0.020608, -0.089640, 0.027328, -0.081425,
0.029546, -0.056999, -0.072555, 0.157434, -0.086864, 0.121743, -0.109717,
0.021964, -0.005303, -0.008638, 0.103944, 0.043414, -0.048438, -0.068368,
-0.083681, -0.057803, -0.144333, -0.064629, 0.122060, 0.026803, 0.034922,
0.030835, 0.041026, -0.070949, 0.008700, -0.085131, 0.078431, 0.045956,
-0.021545, -0.023811, 0.105220, 0.129762, -0.008003, 0.000492, -0.104697,
-0.095998, 0.012324, -0.062647, -0.039653, -0.115462, 0.004978, 0.065040,
0.057513, -0.011423, -0.062862, 0.033717, 0.043713, 0.114048, 0.125850,
-0.001158, 0.051298, -0.035661, -0.065053, -0.065325, -0.076486, 0.072497,
-0.070143, 0.087098, -0.001741, 0.030005, 0.066398, 0.010667, -0.102212,
0.025889, 0.019134, -0.025586, -0.067510, -0.032557, 0.102225, -0.073262,
-0.072487, 0.012231, -0.034143, -0.070517, -0.167683, -0.043935, -0.080799,
-0.030892, 0.147476, 0.021172, 0.011331, 0.154859, 0.066047, 0.096293,
-0.149617, 0.126006, -0.028224, 0.071430, 0.067893, 0.020646, 0.041123,
-0.151067, 0.064473, -0.067797, -0.139525, -0.060627, -0.014693, -0.061172,
0.082480, 0.084268, -0.023626, 0.035434, -0.119684, 0.099778, -0.011947,
-0.088271, 0.131585, -0.041440, 0.176873, 0.048456, -0.048905, -0.075228,
0.044310, -0.075683, 0.024314, 0.055697, -0.043726, -0.022672, -0.063203,
-0.066300, -0.051360, 0.017351, 0.013834, 0.186747, 0.011327, -0.003043,
-0.001537, -0.012541, 0.262074, 0.106204, 0.065185, -0.089573, 0.112326,
-0.102839, -0.050785, 0.024563, 0.090853, -0.087787, 0.071663, 0.083007,
-0.094541, -0.101002, 0.027209, 0.032045, 0.128395, -0.043404, 0.023079,
0.104146, 0.068948, 0.005951, 0.135905, 0.004061, 0.046340, -0.022355,
-0.156086, -0.063026, -0.058503, -0.056173, 0.018005, -0.150706, 0.115545,
-0.037423, 0.023241, 0.044750, 0.119637, -0.112694, 0.000697, 0.134559,
0.050195, -0.053417, 0.024668, -0.126974, 0.085872, -0.073255, 0.136172,
0.084637, -0.114083, -0.130431, 0.045618, -0.148988, -0.033050, 0.067009,
-0.074574, -0.098346, -0.013597, 0.047603, -0.021043, -0.010601, 0.040224,
0.081322, 0.140310, -0.088675, 0.012686, 0.048434, -0.080941, 0.080216,
0.048498, -0.113674, -0.093648, -0.149809, -0.012979, -0.042670, -0.026790,
-0.109690, -0.119253, 0.006012, -0.014335, -0.048414, 0.029826, 0.106748,
0.116641, 0.063571, 0.038099, 0.020028, -0.148810, 0.145566, 0.117465, 0.091015,
0.010108, -0.005085, -0.120430, 0.054448, 0.013961, -0.094203, 0.109635,
0.012686, -0.049442, 0.034945, -0.126386, 0.027963, 0.034140, -0.125824,
0.028194, -0.111384, 0.039895, -0.156512, 0.018653, 0.093833, -0.141670,
-0.052041, -0.031516, 0.013519, 0.039824, 0.056851, -0.091793, -0.028620,
-0.114363, -0.114613, -0.096673, 0.033733, -0.120477, 0.029963, 0.118140,
-0.109395, 0.014073, 0.046033, -0.023355, -0.010153, 0.000388, -0.023183,
-0.150971, 0.036666, -0.412498, -0.267179, -0.236269, -0.061792, -0.073806,
0.093282, -0.005277, -0.091781, 0.104899, -0.003506, 0.172378, 0.067580,
0.005480, 0.060041, -0.031029, -0.303147, -0.194194, 0.009405, 0.163743,
0.246891, 0.352135, 0.066783, 0.041563, 0.072825, 0.204311, 0.004146, -0.012555,
0.151334, 0.004951, -0.079969, -0.259130, -0.041994, -0.029921, -0.204249,
-0.027995, 0.130825, 0.114833, 0.037905, -0.043813, -0.039852, -0.225996,
0.053521, 0.524277, -0.032739, 0.068390, 0.200730, 0.025178, -0.232980,
-0.066280, -0.044636, -0.003162, 0.163479, -0.011772, 0.116585, -0.123975,
-0.297120, -0.006864, -0.022445, -0.040379, 0.007134, 0.022325, 0.004152,
0.032045, -0.108741, -0.016437, -0.086728, -0.124562, 0.006134, -0.092968,
-0.164969, -0.057630, -0.006363, -0.127356, 0.069828, 0.062675, -0.119609,
0.011963, -0.144916, 0.054156, -0.020704, -0.002233, -0.070451, -0.040296,
-0.078555, 0.079500, -0.060727, 0.064885, -0.090138, 0.030095, 0.047589,
-0.092181, 0.042245, 0.025844, 0.047617, 0.035198, 0.139747, 0.179356, 0.090038,
0.029618, -0.079918, -0.032220, 0.045670, 0.079883, -0.137336, 0.052040,
-0.036936, -0.062332, -0.111622, 0.069017, -0.044533, -0.126731, -0.106647,
0.189443, -0.001938, 0.076760, -0.056497, 0.096432, 0.021986, 0.036008,
-0.000643, 0.078232, -0.107762, 0.035396, -0.119169, 0.028040, 0.030139,
-0.142152, 0.106408, 0.082540, 0.037594, -0.138523, 0.068015, -0.054468,
0.079216, -0.047624, 0.142554, -0.021554, -0.066136, -0.086807, 0.076358,
0.028860, 0.055496, 0.068934, -0.063612, -0.020647, -0.075914, -0.019686,
0.018901, 0.118354, 0.055989, 0.152714, 0.095883, -0.029693, 0.012679, 0.005422,
0.002685, 0.033454, -0.176499, 0.014801, 0.076235, 0.101955, 0.062534, 0.067609,
0.086694, -0.123479, 0.058834, -0.037512, -0.031522, -0.036120, -0.033339,
0.033899, 0.175992, -0.028990, -0.041687, -0.038645, -0.079057, 0.041462,
0.138565, 0.089811, 0.100670, 0.097213, -0.038317, 0.046590, -0.090542,
0.044694, 0.115964, 0.009878, -0.083435, -0.037039, -0.064047, -0.017071,
-0.042555, 0.053600, 0.090281, -0.001746, -0.037238, 0.133596, 0.044661,
-0.006724, 0.129445, -0.031843, 0.121185, -0.156334, -0.071168, -0.069106,
-0.087940, 0.120825, -0.018894, -0.088980, -0.000436, -0.072299, 0.076148,
0.107342, 0.101399, 0.043936, 0.072894, 0.122754, -0.015541, -0.131692,
-0.002655, -0.010226, -0.082357, -0.035308, -0.046942, -0.061415, 0.014667,
0.044745, 0.078052, -0.043587, 0.041756, -0.141808, -0.003833, 0.143575,
-0.019482, -0.061611, 0.148994, 0.048848, 0.032289, -0.099496, -0.085038,
-0.051603, 0.044550, 0.033226, 0.117618, 0.100160, 0.002160, -0.076179,
-0.075310, -0.061948, 0.137581, 0.072752, -0.041594, -0.172164, -0.036232,
0.031669, 0.042606, 0.061393, -0.075931, 0.027449, -0.067585, -0.147679,
0.107824, -0.140271, -0.133352, 0.024518, -0.058683, 0.088412, 0.089089,
-0.027886, -0.000921, 0.030948, -0.075563, -0.002893, 0.039184, 0.022194,
-0.076478, -0.050837, 0.140753, -0.072303, 0.067858, 0.076929, 0.032522,
-0.083791, -0.035965, -0.057875, 0.088124, 0.103760, -0.055461, -0.063631,
-0.045974, 0.006085, -0.087034, -0.035044, -0.023794, 0.088826, 0.159242,
0.073597, -0.020721, -0.030056, -0.020561, -0.083402, 0.122320, -0.057758,
-0.051071, -0.088807, -0.152343, -0.122788, -0.154923, 0.011606, 0.156111,
-0.018923, 0.013927, 0.011990, -0.121731, -0.000499, -0.008456, -0.020841,
0.075020, 0.076914, -0.098237, 0.013018, -0.190827, 0.065308, 0.135420,
-0.011865, -0.140040, 0.054996, 0.035557, -0.076606, -0.110130, -0.115000,
-0.020481, 0.041325, 0.088261, -0.133245, 0.064253, -0.050024, -0.006640,
-0.015364, 0.121037, 0.136944, -0.084041, -0.121578, 0.081857, -0.104312,
-0.125016, 0.139142, 0.098881, -0.085478, 0.037920, -0.063292, -0.014839,
-0.058116, 0.065808, 0.032821, 0.031338, 0.124077, -0.139199, 0.092498,
-0.003214, -0.058047, -0.081053, 0.134362, -0.005643, 0.058067, 0.159142,
-0.041300, -0.130895, -0.058911, -0.019829, -0.002868, -0.082867, 0.051237,
0.049861, 0.127992, -0.006539, -0.021617, 0.069394, -0.077099, 0.001471,
0.128198, -0.134917, 0.111575, -0.145393, 0.042595, 0.003583, 0.076212,
0.150799, -0.093849, 0.128668, -0.093932, -0.062894, 0.087789, -0.079820,
0.100652, 0.170369, -0.002705, 0.038799, -0.073081, 0.049205, 0.061140,
0.054622, -0.082256, 0.034905, -0.091786, -0.077608, -0.046721, 0.024079,
0.040990, 0.107377, 0.133218, -0.100230, 0.049092, 0.058889, 0.028422,
-0.018441, 0.040368, 0.094799, -0.018420, -0.139045, 0.054965, -0.014458,
0.071759, 0.112087, 0.154562, -0.104848, 0.020640, -0.092950, 0.031093,
-0.075136, 0.146391, -0.008751, -0.069192, -0.077310, -0.075694, -0.062585,
-0.120283, -0.006450, 0.095723, 0.030821, 0.078806, -0.008992, -0.040851,
0.011578, 0.023510, 0.077761, -0.014277, 0.075333, 0.049620, 0.124329,
-0.042712, 0.092083, -0.032441, 0.092168, 0.088093, 0.011319, 0.004674,
-0.024510, -0.088306, 0.076974, -0.034369, 0.101923, 0.059365, 0.031330,
0.086535, -0.000271, 0.000050, -0.041600, -0.063127, 0.039686, -0.071771,
0.004625, 0.103166, 0.109620, 0.065478, 0.104507, -0.110598, 0.036050, 0.045021,
0.015430, -0.084454, -0.088884, 0.092973, 0.103760, -0.025444, 0.156699,
-0.107100, -0.111924, 0.112301, -0.128167, -0.002421, 0.004630, 0.008591,
0.056769, -0.024999, 0.024038, -0.066914, -0.093869, 0.018653, 0.058595,
0.046849, 0.159077, 0.005877, -0.012279, -0.072152, -0.045673, -0.001262,
-0.008438, 0.078567, -0.029207, -0.136145, 0.083768, 0.114114, 0.149125,
0.025288, -0.242566, 0.137068, -0.237171, 0.068406, 0.206985, -0.052670,
0.365070, -0.381942, -0.072804, -0.089239, -0.034405, -0.065756, -0.097617,
0.028251, -0.081861, -0.026414, -0.048896, -0.082844, 0.058636, 0.122880,
0.122525, 0.085392, 0.019814, -0.001787, 0.027714, 0.045853, -0.056767,
0.003831, 0.138787, 0.016376, -0.160829, -0.252721, 0.176047, -0.211387,
0.068982, -0.054013, -0.040574, 0.065333, 0.033969, -0.255839, 0.220117,
0.138586, -0.108894, -0.046725, -0.099122, 0.137342, 0.196775, 0.197414,
0.084559, 0.094934, -0.010969, -0.236598, 0.145739, -0.099247, 0.098921,
0.032073, -0.071754, -0.144996, 0.042326, 0.128762, -0.071662, -0.080681,
-0.057021, -0.004368, 0.126111, 0.052401, 0.085074, -0.092665, -0.010938,
0.047485, -0.052679, -0.018358, 0.031208, 0.221287, 0.256126, -0.061270,
0.068551, -0.038404, -0.039270, 0.028219, 0.057861, -0.015322, -0.158458,
-0.115952, 0.085150, -0.136828, 0.023889, 0.163755, -0.004749, 0.164906,
0.016759, -0.005113, -0.194955, -0.130220, 0.158752, 0.135207, 0.035460,
0.144524, 0.077326, 0.081925, 0.119858, -0.027584, -0.101403, 0.007346,
-0.087027, 0.053908, 0.077941, 0.042464, -0.009695, 0.048812, -0.079563,
0.042689, -0.106269, -0.183168, 0.040874, 0.094736, 0.032019, -0.038078,
-0.086363, 0.173793, 0.161427, 0.052171, -0.001699, 0.146056, -0.029838,
-0.015699, -0.069416, -0.002513, 0.123144, -0.147290, -0.049514, -0.049319,
-0.079796, 0.043567, -0.071394, 0.047069, -0.076412, -0.100117, 0.106740,
-0.063550, -0.015501, -0.007963, -0.067873, 0.000942, 0.132848, 0.038985,
-0.191996, -0.038856, 0.090630, 0.027204, -0.026111, 0.104686, 0.099848,
-0.012312, 0.032923, -0.080151, -0.079157, -0.157920, -0.046251, -0.037688,
-0.126032, 0.038902, 0.023727, 0.074659, 0.114139, 0.038637, -0.104170,
-0.035675, 0.020686, -0.027845, -0.049430, -0.106277, -0.091357, -0.100031,
-0.070899, -0.000881, -0.126251, -0.092312, -0.005379, -0.004684, 0.004120,
-0.009394, -0.079742, 0.068318, 0.080854, -0.037909, -0.028970, 0.038823,
-0.009229, -0.030218, -0.104704, 0.079725, 0.054366, -0.007405, 0.111654,
0.011410, -0.125006, 0.025178, -0.040087, -0.091004, 0.131633, 0.251576,
0.007759, -0.136297, 0.108901, 0.051471, 0.011793, -0.051420, 0.014724,
-0.027723, -0.109072, -0.071898, 0.006463, 0.065900, -0.070548, 0.061753,
0.046297, 0.114177, -0.031907, -0.070324, -0.126870, -0.021197, -0.041937,
0.061344, 0.009597, 0.125926, -0.031005, 0.037044, 0.103439, -0.005383,
-0.061062, -0.029383, 0.008492, 0.047420, 0.113659, -0.009967, -0.007200,
0.109659, -0.007882, -0.040400, 0.038939, -0.083416, 0.097291, -0.047046,
0.002875, 0.019630, 0.005154, 0.066883, 0.098180, 0.025767, -0.075379, 0.028420,
-0.020292, 0.046741, 0.129284, -0.013996, 0.088881, -0.067220, -0.051240,
0.018718, 0.035566, -0.092170, -0.024452, 0.048026, 0.014773, -0.150387,
-0.077786, 0.232764, 0.071422, 0.125981, 0.007085, -0.124624, -0.020821,
0.079589, 0.010410, -0.066624, 0.091574, -0.010724, 0.109399, 0.026851,
0.029650, 0.051032, -0.007059, 0.114747, 0.079975, 0.014204, 0.132617, 0.025537,
0.080546, 0.088854, 0.041357, 0.016726, -0.006268, 0.060757, 0.079456,
-0.024459, -0.014514, -0.137369, -0.017165, 0.128486, -0.068797, 0.100513,
0.030085, 0.061340, -0.025631, 0.081091, 0.031482, -0.039883, 0.114057,
-0.039792, 0.022662, -0.042689, 0.013195, 0.054673, -0.050644, 0.006438,
-0.045239, -0.060299, 0.086456, 0.029591, -0.075861, -0.092060, 0.026522,
-0.151206, -0.022701, 0.092877, 0.104038, -0.078595, 0.149512, -0.021743,
-0.309488, 0.065629, 0.043043, 0.124227, 0.028699, 0.152859, 0.045460,
-0.000180, -0.006122, -0.016158, -0.080055, 0.165364, -0.042168, 0.068530,
-0.075797, -0.054742, 0.093884, -0.150652, -0.068126, 0.163370, -0.036980,
0.057459, -0.015288, 0.066010, 0.017715, 0.058048, -0.125016, -0.102956,
0.020605, -0.013992, 0.120447, 0.037642, 0.041172, -0.113551, 0.009764,
0.281907, 0.019335, -0.065399, 0.121939, 0.047091, 0.189871, -0.043663,
0.039707, 0.012607, 0.105876, -0.152281, 0.164647, 0.034163, -0.045440,
0.063409, 0.072238, -0.170657, -0.131943, -0.092695, 0.052848, -0.060641,
-0.085691, -0.026846, -0.132173, 0.065040, 0.016243, 0.002216, -0.005558,
-0.011886, -0.032625, -0.008036, -0.008130, -0.148115, 0.065382, 0.016144,
-0.012946, 0.083100, -0.119403, 0.088468, 0.175896, -0.097895, -0.163907,
0.126116, 0.088318, 0.018006, -0.061230, 0.027192, -0.083011, 0.060964,
-0.078219, 0.082507, -0.120192, -0.083893, -0.078122, 0.022393, -0.091724,
-0.042015, -0.011485, 0.171966, -0.016104, 0.009707, 0.145497, 0.099833,
-0.103727, -0.154498, 0.017377, -0.002430, -0.102979, 0.035766, -0.044525,
-0.002012, -0.084900, -0.075231, 0.037410, 0.097156, -0.019616, -0.018214
};
*/

static const float bias0[] = {
0.099279, -0.080325, 0.222910, 0.141837, 0.116830, 0.127946, 0.150379, 0.078073,
0.056878, -0.017949, 0.205323, -0.077937, 0.129290, 0.015081, 0.130705,
0.204603, 0.003319, 0.017677, 0.010793, 0.041944, 0.058724, 0.184494, -0.051490,
0.089070, 0.175946, -0.044559, 0.160700, -0.273368, 0.114457, 0.068287,
0.103005, 0.246328
};

static const float weights1[] = {
0.168114, 0.101264, 0.066620, 0.054686, 0.013718, 0.125036, 0.074614, -0.067005,
0.004075, 0.091010, 0.085190, -0.210437, -0.046661, 0.038772, 0.119921,
0.033902, 0.013164, 0.235434, -0.011152, -0.025170, -0.145947, 0.103969,
-0.000015, 0.173383, 0.090508, -0.319561, 0.129944, -0.238453, 0.095332,
-0.029796, 0.064062, 0.189099, 0.176547, -0.093040, 0.045366, 0.099989,
0.149906, -0.013451, 0.043908, 0.006565, 0.090523, 0.098269, 0.106591,
-0.144598, 0.193357, -0.139415, 0.008576, 0.168064, -0.111331, -0.072929,
0.114204, -0.050312, -0.082902, 0.010529, -0.115656, 0.172379, 0.196559,
0.152958, 0.021559, -0.102253, -0.020586, 0.153804, 0.223292, -0.122247
};

static const float bias1[] = {
0.093304, 0.006138
};

static void forward(lstm* model) {
    float* temp1 = (float*)kmalloc(sizeof(float) * MAX_LAYER_SIZE, GFP_KERNEL);
    float* temp2 = (float*)kmalloc(sizeof(float) * MAX_LAYER_SIZE, GFP_KERNEL);
    float *curr = temp1, *next = temp2;
    kernel_fpu_begin();

    // Compute it
    float it[LSTM_HIDDEN_SIZE] = {0};

    matrix_vec(model->weight_ih_l, model->input, it, LSTM_HIDDEN_SIZE, LSTM_INPUT_SIZE);
    matrix_vec(model->weight_hh_l, model->h_0, it, LSTM_HIDDEN_SIZE, LSTM_HIDDEN_SIZE);
    vector_sum(model->bias_ih_l, it, it, LSTM_HIDDEN_SIZE);
    vector_sum(model->bias_hh_l, it, it, LSTM_HIDDEN_SIZE);
    sigmoid(it, it, LSTM_HIDDEN_SIZE);

    // Compute ft
    float ft[LSTM_HIDDEN_SIZE] = {0};
    matrix_vec(model->weight_ih_l + (LSTM_HIDDEN_SIZE * LSTM_INPUT_SIZE), model->input, ft,
               LSTM_HIDDEN_SIZE, LSTM_INPUT_SIZE);
    matrix_vec(model->weight_hh_l + (LSTM_HIDDEN_SIZE * LSTM_HIDDEN_SIZE), model->h_0, ft,
               LSTM_HIDDEN_SIZE, LSTM_HIDDEN_SIZE);
    vector_sum(model->bias_ih_l + LSTM_HIDDEN_SIZE, ft, ft, LSTM_HIDDEN_SIZE);
    vector_sum(model->bias_hh_l + LSTM_HIDDEN_SIZE, ft, ft, LSTM_HIDDEN_SIZE);
    sigmoid(ft, ft, LSTM_HIDDEN_SIZE);

    // Compute gt
    float gt[LSTM_HIDDEN_SIZE] = {0};
    matrix_vec(model->weight_ih_l + (2 * LSTM_HIDDEN_SIZE * LSTM_INPUT_SIZE), model->input, gt,
               LSTM_HIDDEN_SIZE, LSTM_INPUT_SIZE);
    matrix_vec(model->weight_hh_l + (2 * LSTM_HIDDEN_SIZE * LSTM_HIDDEN_SIZE), model->h_0, gt,
               LSTM_HIDDEN_SIZE, LSTM_HIDDEN_SIZE);
    vector_sum(model->bias_ih_l + 2 * LSTM_HIDDEN_SIZE, gt, gt, LSTM_HIDDEN_SIZE);
    vector_sum(model->bias_hh_l + 2 * LSTM_HIDDEN_SIZE, gt, gt, LSTM_HIDDEN_SIZE);
    fast_tanh(gt, gt, LSTM_HIDDEN_SIZE);

    // Compute output
    matrix_vec(model->weight_ih_l + (3 * LSTM_HIDDEN_SIZE * LSTM_INPUT_SIZE), model->input,
               model->output, LSTM_HIDDEN_SIZE, LSTM_INPUT_SIZE);
    matrix_vec(model->weight_hh_l + (3 * LSTM_HIDDEN_SIZE * LSTM_HIDDEN_SIZE), model->h_0,
               model->output, LSTM_HIDDEN_SIZE, LSTM_HIDDEN_SIZE);
    vector_sum(model->bias_ih_l + 3 * LSTM_HIDDEN_SIZE, model->output, model->output,
               LSTM_HIDDEN_SIZE);
    vector_sum(model->bias_hh_l + 3 * LSTM_HIDDEN_SIZE, model->output, model->output,
               LSTM_HIDDEN_SIZE);
    sigmoid(model->output, model->output, LSTM_HIDDEN_SIZE);

    // Compute the cell state
    hadamard_product(ft, model->c_0, model->c_1, LSTM_HIDDEN_SIZE);
    hadamard_product(it, gt, model->c_1, LSTM_HIDDEN_SIZE);

    // Compute the hidden layer
    fast_tanh(model->c_1, model->c_0, LSTM_HIDDEN_SIZE);
    hadamard_product(model->output, model->c_0, model->h_0, LSTM_HIDDEN_SIZE);

    // Trade the c0 and c1;
    float* temp = model->c_0;
    model->c_0 = model->c_1;
    model->c_1 = temp;
    memset(model->c_1, 0, sizeof(float) * LSTM_HIDDEN_SIZE);
    
    // Layer 0
    for(int i = 0; i < 32; i++) {
        float sum = 0.0f;
        for(int j = 0; j < 64; j++) {
            sum += model->input[j] * weights0[i * 64 + j];
        }
        curr[i] = sum + bias0[i];
        curr[i] = curr[i] > 0.0f ? curr[i] : 0.0f;
    }

    // Output Layer
    for(int i = 0; i < 2; i++) {
        float sum = 0.0f;
        for(int j = 0; j < 32; j++) {
            sum += curr[j] * weights1[i * 32 + j];
        }
        model->output[i] = sum + bias1[i];
    }

    kernel_fpu_end();
}


// output print function
void printArr(float* arr, int n) {
    for (int i = 0; i < n; i++){
          float x = arr[i];
          int int_x = (int) x;
          float dec_x_temp = (x-int_x)*1000;
          int dec_x = (int) dec_x_temp;
        pr_info("%u.%u", int_x, dec_x);
        pr_info("\n");
    }
}

// Example usage function
int __init init_module(void){
    pr_info("Kernel Module Init \n");
    kernel_fpu_begin();
    // float input [INPUT_SIZE];
    // float output [OUTPUT_SIZE];
    // for (int i = 0; i < INPUT_SIZE; i++){
    //         input [i] = 0.1;
    // }
    lstm* model = vmalloc(sizeof(lstm));
    // zero out hidden layer
    memset(model->h_0, 0, sizeof(model->h_0));
    forward(model);
    printArr(model->output, OUTPUT_SIZE);
    kernel_fpu_end();
    vfree(model);
    return 0;
}

void __exit cleanup_module(void)
{

	pr_info("Goodbye \n");
}

MODULE_LICENSE("GPL");
                
